# M5 — План интеграции карт предсказаний в статью

## Текущее состояние

- **Скрипты**: `approximated/` содержит полный пайплайн для попиксельных карт:
  - Ridge (geo-spectral): `pixel_geo_approx.py`
  - RF (40+ фич): `rf_pixel_maps.py`, `rf_pixel_geo_maps.py`
  - Ensemble (Stack + Kriging): `rf_ensemble_maps.py`
- **Ферма**: «Агро Парасат» (UTM 41N, 2023)
- **Пиксельные данные**: CSV с ~32K inside-пикселей + TIFF `s2_2023-06-05_B4B8B3B5B11.tif`
- **Обученные RF**: `math_statistics/output/rf/rf_models/rf_{element}.pkl`
- **Выходные PNG карт: ОТСУТСТВУЮТ** (директория `output/plots/` пуста)
- **Входной CSV пикселей**: `pixels_Агро_Парасат_2023_real.csv` — **отсутствует**, генерируется `pixel_ndvi_real.py`

## Ограничение п.9 статьи (discussion → limitations)

> «Карты предсказаний: итоговые пространственные карты предсказанных свойств почв не представлены;
> их генерация и валидация являются предметом будущей работы.»

## Предлагаемый план (5 шагов)

### Шаг 1. Генерация пиксельных данных
```bash
cd approximated
python pixel_ndvi_real.py   # → pixels_Агро_Парасат_2023_real.csv
```
Проверить, что CSV содержит ~32K пикселей с координатами и спектральными индексами.

### Шаг 2. Генерация карт RF
```bash
python rf_pixel_geo_maps.py   # → rf_geo_Агро_Парасат_2023_{element}.png + summary
```
Это основной формат: спутниковая подложка + попиксельные предсказания RF в границах полигонов +
сглаженная интерполяция за их пределами.

**Методологическое требование**: использовать 15 MDI-отобранных признаков (из `data/features/selected/`)
вместо старого sweep по 10-50 фичам. Это обеспечит консистентность с основными экспериментами статьи.

### Шаг 3. Выбор элементов для демонстрации
Рекомендуемый набор для фигуры в статье:
- **pH** (лучший Farm-LOFO: ρ=0.750) — визуально убедительная карта
- **P₂O₅** (Farm-LOFO: ρ=0.571) — демонстрация умеренного результата
- **NO₃** (Farm-LOFO: ρ=0.232) — демонстрация «провала» для контраста

Формат фигуры: 3×1 или 1×3 subplot, RGB подложка + colorbar + границы полей.

### Шаг 4. Добавление фигуры в статью
```latex
\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{fig12_prediction_maps.png}
  \caption{Pixel-level soil property prediction maps for farm ``Agro Parasat''
  (2023): (a)~pH, (b)~P$_2$O$_5$, (c)~NO$_3$.
  RF model with 15~MDI-selected features; predictions inside field polygons
  are from actual pixel spectra, outside areas use nearest-neighbour
  interpolation with Gaussian smoothing.
  Colour indicates predicted values; field boundaries shown in black.}
  \label{fig:prediction_maps}
\end{figure}
```

Место вставки: после раздела `\subsection{Farm-LOFO-CV}` или в конце Results
перед «Статистическая значимость».

### Шаг 5. Обновление текста
1. **Удалить** ограничение №9 из `discussion.tex`:
   > «Карты предсказаний: итоговые пространственные карты...»
2. **Добавить** подраздел в Results (~5 предложений): описание карт,
   визуальная интерпретация (градиенты pH совпадают с топографией / границами полей,
   NO₃ карта — шумная, подтверждает слабую пространственную предсказуемость).
3. **Обновить** Discussion: обсудить практическую применимость карт для точного земледелия
   (pH — операционно пригоден, NO₃ — нет).

## Риски и зависимости

| Риск | Митигация |
|------|-----------|
| `pixels_*.csv` отсутствует | Запустить `pixel_ndvi_real.py` заново |
| RF-модели обучены на 40+ фичах (не 15 MDI) | Переобучить RF на 15 MDI-признаках перед генерацией карт |
| SoilGrids фичи в старых RF-моделях | Проверить `rf_feature_selection_best.csv` → исключить |
| Спутниковая подложка (contextily) требует интернет | Кэшировать тайлы заранее |

## Оценка трудозатрат

- Генерация CSV + карт: ~2 часа (с учётом отладки)
- Адаптация скрипта под 15 MDI-признаков: ~1 час
- LaTeX-интеграция и текст: ~30 мин
- **Итого: ~3.5 часа**
